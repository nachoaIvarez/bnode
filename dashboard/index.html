<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bitcoin Node</title>
<style>
:root {
  --btc: #f7931a;
  --night-50: #c9d1d9;
  --night-100: #8b949e;
  --night-200: #6e7681;
  --night-300: #484f58;
  --night-400: #30363d;
  --night-500: #21262d;
  --night-600: #161b22;
  --night-700: #0d1117;
  --ok: #3fb950;
  --warn: #d29922;
  --err: #f85149;
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  --font-serif: Georgia, "Times New Roman", serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: #050810;
  min-height: 100vh;
  color: var(--night-50);
  font-family: var(--font-mono);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

::selection { background: rgba(247, 147, 26, 0.2); color: var(--btc); }

.hidden { display: none; }

/* --- effects --- */

.grain::after {
  content: ''; position: fixed; inset: 0; opacity: 0.025; pointer-events: none; z-index: 50;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

.scanline::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 40;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
}

/* --- animations --- */

@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes bar-glow { 0%, 100% { box-shadow: 0 0 8px #f7931a33; } 50% { box-shadow: 0 0 24px #f7931a55; } }
@keyframes count-glow { 0%, 100% { text-shadow: 0 0 20px #f7931a22; } 50% { text-shadow: 0 0 40px #f7931a44; } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

.fade-in { animation: fadeIn 0.6s ease both; }
.stagger-1 { animation-delay: 50ms; }
.stagger-2 { animation-delay: 100ms; }
.stagger-3 { animation-delay: 150ms; }
.stagger-4 { animation-delay: 200ms; }
.stagger-5 { animation-delay: 250ms; }
.stagger-6 { animation-delay: 300ms; }
.stagger-7 { animation-delay: 350ms; }
.pulse-soft { animation: pulse-soft 2.5s ease-in-out infinite; }
.bar-glow { animation: bar-glow 2s ease-in-out infinite; }

.progress-shimmer { position: relative; overflow: hidden; }
.progress-shimmer::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
  animation: shimmer 2s ease-in-out infinite;
}

/* --- syncing state --- */

@keyframes sync-glow {
  0%, 100% { border-color: rgba(247, 147, 26, 0.1); }
  50% { border-color: rgba(247, 147, 26, 0.3); }
}

.hero-card.is-syncing { animation: sync-glow 3s ease-in-out infinite; }

.sync-pill-warn {
  background: rgba(247, 147, 26, 0.1);
  border: 1px solid rgba(247, 147, 26, 0.2);
}
.sync-pill-warn .sync-dot { background: var(--btc); }
.sync-pill-warn .sync-text { color: var(--btc); }

/* --- layout --- */

.container {
  position: relative;
  max-width: 64rem;
  margin: 0 auto;
  padding: 2rem 1rem;
}

/* --- cards --- */

.card {
  background: rgba(13, 17, 23, 0.5);
  backdrop-filter: blur(4px);
  border: 1px solid rgba(33, 38, 45, 0.5);
  border-radius: 0.75rem;
  padding: 1rem;
  box-shadow: inset 0 1px 0 0 rgba(255, 255, 255, 0.03);
}

.card-lg { border-radius: 1rem; padding: 1.5rem; }

/* --- header --- */

header { margin-bottom: 2.5rem; }

.header-row {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 0.75rem;
}

.brand { display: flex; align-items: baseline; gap: 0.75rem; }

.brand-symbol {
  font-family: var(--font-serif);
  font-size: 3rem;
  line-height: 1;
  color: var(--btc);
  text-shadow: 0 0 40px #f7931a33, 0 0 80px #f7931a11;
  letter-spacing: -0.025em;
  font-style: italic;
  font-weight: normal;
}

.brand-name {
  font-family: var(--font-serif);
  font-size: 1.875rem;
  line-height: 1;
  color: rgba(255, 255, 255, 0.9);
  letter-spacing: -0.025em;
  font-weight: normal;
}

.brand-version {
  font-size: 10px;
  color: var(--night-200);
  margin-top: 0.25rem;
  letter-spacing: 0.025em;
}

.header-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 11px;
  color: var(--night-200);
}

.chain-label {
  padding: 0.125rem 0.5rem;
  border-radius: 0.25rem;
  border: 1px solid rgba(48, 54, 61, 0.5);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 600;
  font-size: 10px;
}

.header-divider {
  margin-top: 1rem;
  height: 1px;
  background: linear-gradient(to right, rgba(247, 147, 26, 0.3), rgba(247, 147, 26, 0.1), transparent);
}

/* --- startup panel --- */

.startup-section, .hero-section, .svc-section { margin-bottom: 1.5rem; }

.startup-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.25rem;
}

.startup-title { font-size: 1.125rem; font-weight: 700; color: white; }
.startup-subtitle { font-size: 0.75rem; color: var(--night-100); margin-top: 0.125rem; }

.boot-steps { display: flex; flex-direction: column; gap: 0.75rem; }
.boot-step { display: flex; align-items: center; gap: 0.75rem; }
.step-check { width: 0.875rem; height: 0.875rem; color: var(--ok); }
.step-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.step-label { font-size: 0.875rem; }
.step-detail { font-size: 11px; color: var(--night-200); margin-left: auto; }
.step-ok { color: var(--ok); }
.step-active { color: var(--btc); }
.step-muted { color: var(--night-200); }
.step-err { color: var(--err); }

.startup-footer {
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(33, 38, 45, 0.3);
}

.startup-footer p {
  font-size: 11px;
  color: var(--night-200);
  line-height: 1.625;
}

.spinner {
  width: 18px; height: 18px;
  border: 2px solid #f7931a33;
  border-top-color: var(--btc);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* --- hero --- */

.hero-card { position: relative; overflow: hidden; }

.hero-shimmer {
  position: absolute; inset: 0; opacity: 0.3; pointer-events: none;
  background: radial-gradient(ellipse at 30% 50%, #f7931a08 0%, transparent 70%);
}

.hero-inner {
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 1rem;
}

.metric-label {
  font-size: 10px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--night-200);
  margin-bottom: 0.75rem;
}

.hero-inner .metric-label { margin-bottom: 0.5rem; }

.block-height {
  font-family: var(--font-mono);
  font-size: 3rem;
  line-height: 1;
  font-weight: 900;
  color: white;
  font-variant-numeric: tabular-nums;
  animation: count-glow 3s ease-in-out infinite;
}

.dc {
  display: inline-block;
  position: relative;
  overflow: hidden;
  width: 1ch;
  height: 1.3em;
  vertical-align: top;
  text-align: center;
}

.dc > span {
  display: block;
  height: 1.3em;
  line-height: 1.3;
}

.dc > .out {
  position: absolute;
  inset: 0;
  animation: digit-out 0.3s ease-in forwards;
}

.dc > .in {
  animation: digit-in 0.3s ease-out forwards;
}

@keyframes digit-out {
  from { transform: translateY(0); opacity: 1; }
  to { transform: translateY(0.5em); opacity: 0; }
}

@keyframes digit-in {
  from { transform: translateY(-0.5em); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.sync-badge {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.5rem;
}

.sync-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.375rem 0.75rem;
  background: rgba(63, 185, 80, 0.1);
  border: 1px solid rgba(63, 185, 80, 0.2);
  border-radius: 9999px;
}

.sync-dot {
  width: 0.5rem; height: 0.5rem;
  border-radius: 50%;
  background: var(--ok);
}

.sync-text {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--ok);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* --- progress --- */

.progress { margin-top: 1.5rem; }
.progress-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
.progress-pct { font-size: 0.875rem; font-weight: 700; color: var(--btc); font-variant-numeric: tabular-nums; }
.progress-blocks { font-size: 0.75rem; color: var(--night-100); font-variant-numeric: tabular-nums; }

.progress-track {
  position: relative;
  width: 100%; height: 0.625rem;
  background: rgba(22, 27, 34, 0.8);
  border-radius: 9999px;
  overflow: hidden;
}

.progress-bar {
  position: relative;
  height: 100%;
  border-radius: 9999px;
  background: linear-gradient(to right, rgba(247, 147, 26, 0.7), var(--btc), var(--btc));
  transition: width 1000ms;
}

.progress-headers {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  border-radius: 9999px;
  background: rgba(247, 147, 26, 0.15);
  transition: width 1000ms;
}

.progress-remaining {
  font-size: 11px;
  color: var(--night-200);
  margin-top: 0.5rem;
  font-variant-numeric: tabular-nums;
}

/* --- service pills --- */

.svc-strip { display: flex; flex-wrap: wrap; gap: 0.5rem; }

.pill {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.625rem;
  border: 1px solid;
  border-radius: 9999px;
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.025em;
}

.pill-ok { background: rgba(63, 185, 80, 0.1); border-color: rgba(63, 185, 80, 0.2); color: var(--ok); }
.pill-warn { background: rgba(210, 153, 34, 0.1); border-color: rgba(210, 153, 34, 0.2); color: var(--warn); }
.pill-err { background: rgba(248, 81, 73, 0.1); border-color: rgba(248, 81, 73, 0.2); color: var(--err); }

.pill-dot {
  width: 0.375rem; height: 0.375rem;
  border-radius: 50%;
  flex-shrink: 0;
  background: currentColor;
}

/* --- metrics grid --- */

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  transition: opacity 500ms;
}

.metric-value {
  font-size: 1.6rem;
  line-height: 1;
  font-weight: 700;
  color: white;
  font-variant-numeric: tabular-nums;
}

.metric-value-row { display: flex; align-items: baseline; gap: 0.25rem; }
.metric-unit { font-size: 10px; color: var(--night-200); }

.metric-sub {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-top: 0.75rem;
}

.metric-sub span {
  font-size: 0.75rem;
  color: var(--night-100);
  font-variant-numeric: tabular-nums;
}


.metric-detail { font-size: 0.75rem; color: var(--night-100); margin-top: 0.75rem; font-variant-numeric: tabular-nums; }
.metric-detail-label { font-size: 10px; color: var(--night-300); margin-top: 0.75rem; }

.peers-detail { display: flex; gap: 1rem; margin-top: 0.75rem; }
.peer-item { display: flex; align-items: center; gap: 0.375rem; }
.peer-icon { width: 0.75rem; height: 0.75rem; }
.peer-icon-in { color: rgba(63, 185, 80, 0.6); transform: rotate(-90deg); }
.peer-icon-out { color: rgba(247, 147, 26, 0.6); transform: rotate(90deg); }
.peer-value { font-size: 0.75rem; color: var(--night-100); font-variant-numeric: tabular-nums; }
.peer-label { font-size: 9px; color: var(--night-300); }

/* --- detail grid --- */

.detail-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
  margin-bottom: 2.5rem;
}

.info-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.info-header .metric-label { margin-bottom: 0; }

.dot { width: 0.375rem; height: 0.375rem; border-radius: 50%; }
.dot-ok { background: var(--ok); }
.dot-warn { background: var(--warn); }
.dot-err { background: var(--err); }
.dot-muted { background: var(--night-400); }
.dot-btc { background: var(--btc); }

.info-text { font-size: 0.875rem; color: var(--night-100); }
.text-warn { color: var(--warn); }

.onion-addr {
  word-break: break-all;
  line-height: 1.6;
  font-size: 0.625rem;
  color: var(--night-100);
  font-family: var(--font-mono);
  user-select: all;
}

/* --- footer --- */

.footer { text-align: center; }
.timestamp { font-size: 10px; color: var(--night-300); font-variant-numeric: tabular-nums; }

/* --- responsive --- */

@media (min-width: 640px) {
  .container { padding: 2rem 1.5rem; }
  .card { padding: 1.25rem; }
  .card-lg { padding: 2rem; }
  .header-row { flex-direction: row; align-items: flex-end; }
  .brand-symbol { font-size: 3.75rem; }
  .brand-name { font-size: 2.25rem; }
  .hero-inner { flex-direction: row; align-items: flex-end; }
  .sync-badge { align-items: flex-end; }
  .block-height { font-size: 4.5rem; }
  
  .detail-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (min-width: 1024px) {
  .container { padding: 2rem; }
  .metrics-grid { grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>

<body class="grain scanline">

<div class="container">

  <!-- header -->
  <header class="fade-in stagger-1">
    <div class="header-row">
      <div class="brand">
        <h1 class="brand-symbol">&#8383;</h1>
        <div>
          <h2 class="brand-name">Node</h2>
          <div id="node-version" class="brand-version"></div>
        </div>
      </div>
      <div class="header-meta">
        <span id="chain-label" class="chain-label" style="display:none"></span>
        <span id="net-type-label" class="chain-label" style="display:none"></span>
        <span id="uptime-label"></span>
      </div>
    </div>
    <div class="header-divider"></div>
  </header>

  <!-- startup panel (shown during loading/unreachable) -->
  <section id="startup-panel" class="startup-section fade-in stagger-2 hidden">
    <div class="card card-lg">
      <div class="startup-header">
        <div class="spinner"></div>
        <div>
          <div id="startup-title" class="startup-title">starting up</div>
          <div id="startup-subtitle" class="startup-subtitle"></div>
        </div>
      </div>

      <!-- boot sequence -->
      <div class="boot-steps" id="boot-steps"></div>

      <div class="startup-footer">
        <p>
          this is normal. the node needs to load its block index and verify data integrity before accepting connections.
          this can take a few minutes after a restart, or longer on first sync.
          this page updates automatically every second.
        </p>
      </div>
    </div>
  </section>

  <!-- block height hero (shown when syncing/synced) -->
  <section id="hero" class="hero-section fade-in stagger-2 hidden">
    <div class="card card-lg hero-card">
      <div id="hero-shimmer" class="hero-shimmer hidden"></div>
      <div class="hero-inner">
        <div>
          <div class="metric-label">block height</div>
          <div id="block-height" class="block-height">---</div>
        </div>
        <div id="sync-badge" class="sync-badge"></div>
      </div>
      <div id="progress-section" class="progress hidden">
        <div class="progress-header">
          <span id="pct-label" class="progress-pct"></span>
          <span id="blocks-label" class="progress-blocks"></span>
        </div>
        <div class="progress-track">
          <div id="hbar" class="progress-headers" style="width:0%"></div>
          <div id="pbar" class="progress-bar bar-glow progress-shimmer" style="width:0%"></div>
        </div>
        <div id="blocks-behind" class="progress-remaining"></div>
      </div>
    </div>
  </section>

  <!-- services strip -->
  <section class="svc-section fade-in stagger-3">
    <div class="svc-strip" id="svc-strip"></div>
  </section>

  <!-- metrics grid -->
  <section id="metrics-grid" class="metrics-grid">
    <div class="fade-in stagger-4 card">
      <div class="metric-label">peers</div>
      <div id="peers-total" class="metric-value">--</div>
      <div class="peers-detail">
        <div class="peer-item">
          <svg class="peer-icon peer-icon-in" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
          <span id="peers-in" class="peer-value">--</span>
          <span class="peer-label">in</span>
        </div>
        <div class="peer-item">
          <svg class="peer-icon peer-icon-out" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
          <span id="peers-out" class="peer-value">--</span>
          <span class="peer-label">out</span>
        </div>
      </div>
    </div>
    <div class="fade-in stagger-5 card">
      <div class="metric-label">mempool</div>
      <div class="metric-value-row">
        <span id="mem-tx" class="metric-value">--</span>
        <span class="metric-unit">txs</span>
      </div>
      <div class="metric-sub">
        <span id="mem-vsize">--</span>
        <span id="mem-fees">--</span>
      </div>
    </div>
    <div class="fade-in stagger-6 card">
      <div class="metric-label">hashrate</div>
      <div id="hashrate" class="metric-value">--</div>
      <div id="difficulty" class="metric-detail"></div>
    </div>
    <div class="fade-in stagger-7 card">
      <div class="metric-label">chain data</div>
      <div id="disk" class="metric-value">--</div>
      <div class="metric-detail-label">on disk</div>
    </div>
  </section>

  <!-- electrs + tor -->
  <section class="detail-grid">
    <div class="fade-in stagger-6 card">
      <div class="info-header">
        <div class="metric-label">electrs index</div>
        <span id="electrs-dot" class="dot"></span>
      </div>
      <div id="electrs-info" class="info-text"></div>
    </div>
    <div class="fade-in stagger-7 card">
      <div class="info-header">
        <div class="metric-label">tor hidden service</div>
        <span id="tor-dot" class="dot"></span>
      </div>
      <div id="tor-addr" class="onion-addr">--</div>
    </div>
  </section>

  <footer class="footer">
    <div id="ts" class="timestamp"></div>
  </footer>
</div>

<script>
var N = function(n) { return Number(n).toLocaleString(); };
function fmtBytes(b) {
  if (b >= 1e12) return (b / 1e12).toFixed(2) + ' TB';
  if (b >= 1e9) return (b / 1e9).toFixed(1) + ' GB';
  if (b >= 1e6) return (b / 1e6).toFixed(1) + ' MB';
  return b + ' B';
}
function fmtHash(h) {
  if (h >= 1e18) return (h / 1e18).toFixed(1) + ' EH/s';
  if (h >= 1e15) return (h / 1e15).toFixed(1) + ' PH/s';
  if (h >= 1e12) return (h / 1e12).toFixed(1) + ' TH/s';
  return N(h) + ' H/s';
}
function fmtDiff(d) {
  if (d >= 1e12) return (d / 1e12).toFixed(2) + 'T';
  if (d >= 1e9) return (d / 1e9).toFixed(2) + 'G';
  return N(d);
}
function fmtBTC(s) { return s <= 0 ? '0 BTC' : parseFloat(s).toFixed(4) + ' BTC'; }
function fmtUp(s) {
  if (s <= 0) return '--';
  var d = Math.floor(s / 86400), h = Math.floor((s % 86400) / 3600), m = Math.floor((s % 3600) / 60);
  if (d > 0) return d + 'd ' + h + 'h';
  if (h > 0) return h + 'h ' + m + 'm';
  return m + 'm';
}
function pill(name, status) {
  var cls = { ok: 'pill-ok', syncing: 'pill-warn', loading: 'pill-warn', unreachable: 'pill-err' };
  var c = cls[status] || 'pill-err';
  return '<div class="pill ' + c + '">' +
    '<span class="pill-dot' + (status === 'ok' ? ' pulse-soft' : '') + '"></span>' + name + '</div>';
}
function dotClass(s) {
  return s === 'ok' ? 'dot-ok pulse-soft' : s === 'loading' || s === 'syncing' ? 'dot-warn' : 'dot-err';
}

function bootStep(label, status, detail) {
  var dc = { ok: 'dot-ok', waiting: 'dot-muted pulse-soft', active: 'dot-btc pulse-soft', err: 'dot-err' };
  var tc = { ok: 'step-ok', waiting: 'step-muted', active: 'step-active', err: 'step-err' };
  var d = dc[status] || dc.waiting;
  var t = tc[status] || tc.waiting;
  var check = status === 'ok' ? '<svg class="step-check" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' :
    '<span class="step-dot ' + d + '"></span>';
  return '<div class="boot-step">' + check +
    '<span class="step-label ' + t + '">' + label + '</span>' +
    (detail ? '<span class="step-detail">' + detail + '</span>' : '') +
    '</div>';
}

function isStarting(d) {
  var b = d.services.bitcoind;
  return b.status === 'loading' || b.status === 'unreachable';
}

function svcToStep(status) {
  if (status === 'ok') return 'ok';
  if (status === 'loading' || status === 'syncing') return 'active';
  return 'waiting';
}
function svcDetail(name, status) {
  var details = {
    tor:      { ok: 'hidden service ready', active: 'bootstrapping', waiting: '' },
    mariadb:  { ok: 'ready', active: 'starting', waiting: '' },
    bitcoind: { ok: 'ready', active: '', waiting: 'not started yet' },
    electrs:  { ok: 'ready', active: 'indexing', waiting: 'waiting for bitcoind' },
    mempool:  { ok: 'ready', active: 'connecting', waiting: 'waiting for electrs' },
  };
  return (details[name] || {})[svcToStep(status)] || status;
}

function renderStartup(d) {
  var b = d.services.bitcoind, tor = d.services.tor, db = d.services.mariadb,
      el = d.services.electrs, mem = d.services.mempool;

  var title = 'starting up';
  var subtitle = 'services are initializing';
  if (b.status === 'loading' && b.message) {
    title = b.message.replace(/\.\.\.$/, '').replace(/…$/, '').toLowerCase();
    subtitle = 'bitcoind is preparing, other services will follow';
  } else if (b.status === 'unreachable') {
    title = 'waiting for bitcoind';
    subtitle = 'the node process has not started yet';
  }
  document.getElementById('startup-title').textContent = title;
  document.getElementById('startup-subtitle').textContent = subtitle;

  var btcStep = b.status === 'loading' ? 'active' : 'waiting';
  var btcDetail = b.status === 'loading' ? (b.message || 'loading...') : 'not started yet';

  var steps = '';
  steps += bootStep('tor', svcToStep(tor.status), svcDetail('tor', tor.status));
  steps += bootStep('mariadb', svcToStep(db.status), svcDetail('mariadb', db.status));
  steps += bootStep('bitcoind', btcStep, btcDetail);
  steps += bootStep('electrs', svcToStep(el.status), svcDetail('electrs', el.status));
  steps += bootStep('mempool', svcToStep(mem.status), svcDetail('mempool', mem.status));

  document.getElementById('boot-steps').innerHTML = steps;
}

var _publicTip = 0;

function fetchPublicTip() {
  fetch('https://mempool.space/api/blocks/tip/height')
    .then(function(r) { return r.ok ? r.text() : null; })
    .then(function(t) { if (t) _publicTip = parseInt(t, 10) || 0; })
    .catch(function() {});
}
fetchPublicTip();
setInterval(fetchPublicTip, 60000);

var _prevBlockStr = '';

function renderBlockHeight(el, str) {
  var prev = _prevBlockStr;
  _prevBlockStr = str;
  if (str === prev) return;
  var animate = prev && prev !== '---' && str !== '---';
  var maxLen = Math.max(str.length, animate ? prev.length : 0);
  var pOld = animate ? prev.padStart(maxLen) : '';
  var pNew = str.padStart(maxLen);
  var frag = document.createDocumentFragment();
  for (var i = 0; i < pNew.length; i++) {
    var ch = pNew[i];
    if (ch === ' ') continue;
    var col = document.createElement('span');
    col.className = 'dc';
    var oldCh = pOld[i];
    var diff = animate && oldCh !== ch;
    if (diff && oldCh !== ' ') {
      var out = document.createElement('span');
      out.textContent = oldCh;
      out.className = 'out';
      out.addEventListener('animationend', function() { this.remove(); });
      col.appendChild(out);
    }
    var dig = document.createElement('span');
    dig.textContent = ch;
    if (diff) dig.className = 'in';
    col.appendChild(dig);
    frag.appendChild(col);
  }
  while (el.firstChild) el.removeChild(el.firstChild);
  el.appendChild(frag);
}

function render(d) {
  var b = d.services.bitcoind, el = d.services.electrs, mem = d.services.mempool,
      tor = d.services.tor, db = d.services.mariadb;
  var pct = b.progress ? b.progress * 100 : 0;
  var starting = isStarting(d);

  // toggle startup panel vs hero
  document.getElementById('startup-panel').classList.toggle('hidden', !starting);
  document.getElementById('hero').classList.toggle('hidden', starting);

  // dim metrics when starting
  document.getElementById('metrics-grid').style.opacity = starting ? '0.3' : '1';

  if (starting) {
    renderStartup(d);
  }

  // header meta
  var v = b.version ? b.version.replace(/\//g, '') : '';
  document.getElementById('node-version').textContent = v;
  var cl = b.chain && b.chain !== 'n/a' ? (b.chain === 'main' ? 'mainnet' : b.chain) : '';
  var cle = document.getElementById('chain-label');
  cle.textContent = cl; cle.style.display = cl ? '' : 'none';
  document.getElementById('uptime-label').textContent = b.uptime > 0 ? 'uptime ' + fmtUp(b.uptime) : '';
  var ntl = document.getElementById('net-type-label');
  var ntMap = { 'clearnet+tor': 'CLEARNET + TOR', 'tor': 'TOR ONLY', 'clearnet': 'CLEARNET' };
  var ntText = ntMap[b.network_type] || '';
  ntl.textContent = ntText; ntl.style.display = ntText ? '' : 'none';
  var showBlocks = b.status === 'ok' || b.status === 'syncing';
  renderBlockHeight(document.getElementById('block-height'), showBlocks ? N(b.blocks) : '---');

  // sync state
  var ps = document.getElementById('progress-section'),
      sb = document.getElementById('sync-badge'), hs = document.getElementById('hero-shimmer');
  ps.classList.add('hidden'); sb.innerHTML = ''; hs.classList.add('hidden');
  document.getElementById('hbar').style.width = '0%';
  document.querySelector('.hero-card').classList.toggle('is-syncing', b.status === 'syncing');
  if (b.status === 'syncing') {
    sb.innerHTML = '<div class="sync-pill sync-pill-warn">' +
      '<span class="sync-dot pulse-soft"></span>' +
      '<span class="sync-text">syncing</span></div>';
  }

  if (b.status === 'syncing' && b.blocks === 0) {
    ps.classList.remove('hidden'); hs.classList.remove('hidden');
    document.getElementById('pbar').style.width = '0%';
    var pl = document.getElementById('pct-label');
    pl.textContent = 'downloading headers';
    pl.classList.add('pulse-soft');
    document.getElementById('blocks-label').textContent = b.headers > 0 ? N(b.headers) + ' headers' : 'connecting to peers...';
    document.getElementById('blocks-behind').textContent = 'block sync starts after headers finish';
  } else if (b.status === 'syncing' && b.ibd) {
    ps.classList.remove('hidden'); hs.classList.remove('hidden');
    var tip = _publicTip || b.headers;
    var ibdPct = tip > 0 ? (b.blocks / tip * 100) : 0;
    var hdrPct = tip > 0 ? (b.headers / tip * 100) : 0;
    document.getElementById('pbar').style.width = ibdPct.toFixed(2) + '%';
    document.getElementById('hbar').style.width = hdrPct.toFixed(2) + '%';
    var pl2 = document.getElementById('pct-label');
    pl2.textContent = ibdPct.toFixed(2) + '%';
    pl2.classList.remove('pulse-soft');
    document.getElementById('blocks-label').textContent = _publicTip ? N(_publicTip) + ' tip' : N(b.headers) + ' headers';
    document.getElementById('blocks-behind').textContent = N(b.blocks) + ' synced' + (_publicTip ? ' · ' + N(b.headers) + ' headers' : '');
  } else if (b.status === 'syncing') {
    ps.classList.remove('hidden'); hs.classList.remove('hidden');
    document.getElementById('pbar').style.width = pct.toFixed(2) + '%';
    var pl3 = document.getElementById('pct-label');
    pl3.textContent = pct.toFixed(2) + '%';
    pl3.classList.remove('pulse-soft');
    document.getElementById('blocks-label').textContent = N(b.blocks) + ' / ' + N(b.headers);
    document.getElementById('blocks-behind').textContent = N(b.headers - b.blocks) + ' blocks remaining';
  } else if (b.status === 'ok') {
    sb.innerHTML = '<div class="sync-pill">' +
      '<span class="sync-dot pulse-soft"></span>' +
      '<span class="sync-text">fully synced</span></div>';
  }

  // services strip
  document.getElementById('svc-strip').innerHTML =
    pill('bitcoind', b.status) + pill('electrs', el.status) + pill('mempool', mem.status) +
    pill('tor', tor.status) + pill('mariadb', db.status);

  // metrics
  document.getElementById('peers-total').textContent = N(b.peers);
  document.getElementById('peers-in').textContent = N(b.peers_inbound);
  document.getElementById('peers-out').textContent = N(b.peers_outbound);
  document.getElementById('mem-tx').textContent = N(b.mempool_tx);
  document.getElementById('mem-vsize').textContent = fmtBytes(b.mempool_vsize) + ' vsize';
  document.getElementById('mem-fees').textContent = fmtBTC(b.mempool_fees) + ' in fees';
  document.getElementById('hashrate').textContent = b.hashrate > 0 ? fmtHash(b.hashrate) : '--';
  document.getElementById('difficulty').textContent = b.difficulty > 0 ? fmtDiff(b.difficulty) + ' difficulty' : '';
  document.getElementById('disk').textContent = b.size_on_disk > 0 ? fmtBytes(b.size_on_disk) : '--';

  // electrs
  document.getElementById('electrs-dot').className = 'dot ' + dotClass(el.status);
  var eInfo = '';
  if (el.status === 'ok' && el.tip > 0) {
    eInfo = 'tip: ' + N(el.tip);
    if (b.blocks > 0 && el.tip < b.blocks) eInfo += ' <span class="text-warn">(' + N(b.blocks - el.tip) + ' behind)</span>';
  } else if (el.status === 'loading') { eInfo = 'indexing...'; }
  else { eInfo = el.status; }
  document.getElementById('electrs-info').innerHTML = eInfo;

  // tor
  document.getElementById('tor-dot').className = 'dot ' + dotClass(tor.status);
  document.getElementById('tor-addr').textContent = tor.address && tor.address !== 'n/a' ? tor.address : '--';

  document.getElementById('ts').textContent = 'updated ' + d.timestamp;
}

async function refresh() {
  try {
    var r = await fetch('/api/health.json?' + Date.now());
    if (!r.ok) throw new Error();
    render(await r.json());
  } catch(e) {
    render({
      timestamp: new Date().toISOString(),
      services: {
        bitcoind: { status: 'unreachable', blocks: 0, headers: 0, progress: 0, peers: 0,
          peers_inbound: 0, peers_outbound: 0, message: '',
          chain: 'n/a', difficulty: 0, hashrate: 0, size_on_disk: 0, version: '', uptime: 0,
          mempool_tx: 0, mempool_vsize: 0, mempool_fees: 0,
          ibd: false, network_type: '' },
        electrs: { status: 'unreachable', tip: 0 },
        mempool: { status: 'unreachable', tip: 0 },
        tor: { status: 'unreachable', address: 'n/a' },
        mariadb: { status: 'unreachable' }
      }
    });
  }
}
refresh();
setInterval(refresh, 1000);
</script>
</body>
</html>
